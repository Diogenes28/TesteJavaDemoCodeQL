name: Code Scanning with CodeQL and Veracode

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '37 0 * * 1'  # Roda toda segunda-feira √†s 00:37 UTC

permissions:
  contents: read
  security-events: write  # Necess√°rio para enviar resultados para o GitHub Code Scanning

jobs:
  # üö® JOB 1: An√°lise de seguran√ßa com CodeQL
  codeql-analysis:
    name: CodeQL Security Scan
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: [ 'java' ]  # ‚ùó Altere aqui conforme a linguagem do seu projeto
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # üîí JOB 2: An√°lise de seguran√ßa com Veracode
  veracode-pipeline-scan:
    name: Veracode Pipeline Scan
    runs-on: ubuntu-latest
    needs: codeql-analysis  # S√≥ roda depois que o CodeQL terminar
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Zip source code
        run: zip -r veracode-scan-target.zip ./

      - name: Download Veracode Pipeline Scan
        run: |
          curl --silent --show-error --fail -O https://downloads.veracode.com/securityscan/pipeline-scan-LATEST.zip
          unzip -o pipeline-scan-LATEST.zip

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: 8
          distribution: 'temurin'

      - name: Run Veracode Scan
        run: |
          java -jar pipeline-scan.jar \
          --veracode_api_id "${{ secrets.VERACODE_API_ID }}" \
          --veracode_api_key "${{ secrets.VERACODE_API_KEY }}" \
          --fail_on_severity="Very High, High" \
          --file veracode-scan-target.zip
        continue-on-error: true  # Continua mesmo que o Veracode aponte falhas

      - name: Convert Veracode JSON to SARIF
        id: convert
        uses: veracode/veracode-pipeline-scan-results-to-sarif@ff08ae5b45d5384cb4679932f184c013d34da9be
        with:
          pipeline-results-json: results.json

      - name: Upload SARIF to GitHub
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: veracode-results.sarif
